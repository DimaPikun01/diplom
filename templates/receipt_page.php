<?php
session_start(); // Начало сессии

// Проверка, что пользователь авторизован
if (!isset($_SESSION['service_id'])) {
    http_response_code(403);
    exit("Unauthorized");
}

// Подключение к основной базе данных
include '../database/database.php';

// Подключение к базе данных сервиса
$service_id = $_SESSION['service_id'] ?? null; // Проверьте переменную
if ($service_id === null) {
    http_response_code(400);
    exit("Service ID not found in session.");
}

// Подключение к базе данных сервиса
$stmt = $conn->prepare("SELECT db_name FROM services WHERE id = ?");
if (!$stmt) { // Проверка, что запрос корректен
    die("Error preparing SQL statement.");
}
$stmt->bind_param("i", $service_id);
$stmt->execute();

$db_name = $stmt->get_result()->fetch_assoc()['db_name'] ?? null; // Проверка значения
if ($db_name === null) {
    die("Database name not found.");
}

$service_conn = new mysqli($servername, $username, $password, $db_name);
if ($service_conn->connect_error) {
    http_response_code(500);
    exit("Connection error: " . $service_conn->connect_error);
}

// Получение параметра "id" из URL
$id = $_GET['id'] ?? null;
if ($id === null) {
    http_response_code(400);
    exit("ID not provided.");
}

// Запрос данных из таблицы "Reception"
$stmt = $service_conn->prepare("SELECT * FROM Reception WHERE id = ?");
if (!$stmt) { // Если подготовка запроса не удалась
    die("Error preparing statement.");
}

$stmt->bind_param("i", $id); // Ошибка может быть из-за неправильного объекта
$stmt->execute();

$result = $stmt->get_result(); // Проверка, что результат не пустой
$record = $result->fetch_assoc(); // Получение данных

if ($record === null) { // Если данные не найдены
    die("Record not found.");
}

// Вывод данных на странице
?>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Акт</title>
</head>
<body>
<style>
        body{
            margin: 0;
            padding: 0;
        }
        .print-button {
            margin-top: 20px;
        }
        h2{
            text-align:center;
            margin:0;
        }
        h4{
            text-align:center;
            margin:0;
        }
        h3{
            text-align:center;
            margin:0;
        }
        p{
            margin:0;
            font-size: 13px;
        }
        
    </style>
    <div class="container">
    <h2>Квитанция №<?php echo htmlspecialchars($record['id']); ?></h2>
    <h3>Для клиента: <?php echo htmlspecialchars($record['client_name']); ?></h3>
    <table border='1'>
               <tr>
                  <th>Комплектация</th>
                  <th>Тип устройства</th>
                  <th>Модель</th>
                  <th>Статус</th>
                  <th>Неисправность</th>
                  <th>Стоимость</th>
               </tr>
               <tr>
                  <td>Аппарат/Аккумулятор/Зад.Крышка</td>
                  <td><?php echo htmlspecialchars($record['device_type']); ?></td>
                  <td><?php echo htmlspecialchars($record['model']); ?></td>
                  <td><?php echo htmlspecialchars($record['status']); ?></td>
                  <td><?php echo htmlspecialchars($record['issue']); ?></td>
                  <td><?php echo htmlspecialchars($record['cost']); ?></td>
               </tr>
            </table>
    <p>1.Технический центр не несет ответственности за возможную потерю данных в индивидуальной памяти устройства, связанную с заменой плат, установкой программного обеспечения, заменой носителя информации.</p>
            <p>2. Заказчик принимает на себя риск возможной полной или частичной утраты работоспособности аппарата в процессе ремонта (тепловой обработки), в случае грубых нарушений пользователем условий эксплуатации, наличий следов попадания токопроводящей жидкости (коррозии), либо механических повреждений.</p>
            <p>3. Выписка из СТБ 1303-2007 п11.4. Ремонт ОАУ, эксплуатация которых осуществляется без соблюдения требований, указанных в эксплуатационных документах, т.е подвергшихся воздействию влаги, химических веществ, неквалифицированному вмешательству и имеющие сильные механические повреждения (глубокие вмятины, царапины и трещины на корпусе, деформацию печатных плат, смещение навесных элементов, трещины в керамической подложке микросхем, разрушение конструкций ОАУ м т.п.), производится без предоставления гарантии на оказанную услугу.</p>
            <p>4. Постановление Совета Министров Республики Беларусь от 28.03.2007 № 393 'Об утверждении Правил выполнения работ и оказания услуг по ремонту оконечных абонентских устройств'.</p>
            <p>Если заказчик уклоняется от получения отремонтированного оконечного абонентского устройства, исполнитель после письменного предупреждения заказчика по истечению двух месяцев со дня предупреждения оставляет за собой право распорядиться оконечным абонентским устройством в поряде, определенном законодательством.</p>
            <p>5. При нарушении гарантийных пломб на ОАУ, все гарантийные обязательства перед заказчиком утрачивают свою силу.</p>
            <p>6. При установки детали клиента (корпус, шлейф, индикатор изображения и т.д.) мастерская за функциональность и работоспособность ОАУ ответственности не несет.</p>
            <p>Приемщик:_____________________</p>
            
            <p>Бланк заполнин с моих слов верно. При увеличении срока ремонта на время доставки запчастей претензий иметь не буду.</p>
            <p>От Заказчика:_____________________ <?php echo htmlspecialchars($record['client_name']); ?></p>
            <p>--------------------------------------------------------------------------------------------------</p>
    </div>
    <div class="container">
    <h2>Квитанция №<?php echo htmlspecialchars($record['id']); ?></h2>
    <h3>Для клиента: <?php echo htmlspecialchars($record['client_name']); ?></h3>
    <table border='1'>
               <tr>
                  <th>Комплектация</th>
                  <th>Тип устройства</th>
                  <th>Модель</th>
                  <th>Статус</th>
                  <th>Неисправность</th>
                  <th>Стоимость</th>
               </tr>
               <tr>
                  <td>Аппарат/Аккумулятор/Зад.Крышка</td>
                  <td><?php echo htmlspecialchars($record['device_type']); ?></td>
                  <td><?php echo htmlspecialchars($record['model']); ?></td>
                  <td><?php echo htmlspecialchars($record['status']); ?></td>
                  <td><?php echo htmlspecialchars($record['issue']); ?></td>
                  <td><?php echo htmlspecialchars($record['cost']); ?></td>
               </tr>
            </table>
    <p>1.Технический центр не несет ответственности за возможную потерю данных в индивидуальной памяти устройства, связанную с заменой плат, установкой программного обеспечения, заменой носителя информации.</p>
            <p>2. Заказчик принимает на себя риск возможной полной или частичной утраты работоспособности аппарата в процессе ремонта (тепловой обработки), в случае грубых нарушений пользователем условий эксплуатации, наличий следов попадания токопроводящей жидкости (коррозии), либо механических повреждений.</p>
            <p>3. Выписка из СТБ 1303-2007 п11.4. Ремонт ОАУ, эксплуатация которых осуществляется без соблюдения требований, указанных в эксплуатационных документах, т.е подвергшихся воздействию влаги, химических веществ, неквалифицированному вмешательству и имеющие сильные механические повреждения (глубокие вмятины, царапины и трещины на корпусе, деформацию печатных плат, смещение навесных элементов, трещины в керамической подложке микросхем, разрушение конструкций ОАУ м т.п.), производится без предоставления гарантии на оказанную услугу.</p>
            <p>4. Постановление Совета Министров Республики Беларусь от 28.03.2007 № 393 'Об утверждении Правил выполнения работ и оказания услуг по ремонту оконечных абонентских устройств'.</p>
            <p>Если заказчик уклоняется от получения отремонтированного оконечного абонентского устройства, исполнитель после письменного предупреждения заказчика по истечению двух месяцев со дня предупреждения оставляет за собой право распорядиться оконечным абонентским устройством в поряде, определенном законодательством.</p>
            <p>5. При нарушении гарантийных пломб на ОАУ, все гарантийные обязательства перед заказчиком утрачивают свою силу.</p>
            <p>6. При установки детали клиента (корпус, шлейф, индикатор изображения и т.д.) мастерская за функциональность и работоспособность ОАУ ответственности не несет.</p>
            <p>Приемщик:_____________________</p>
            
            <p>Бланк заполнин с моих слов верно. При увеличении срока ремонта на время доставки запчастей претензий иметь не буду.</p>
            <p>От Заказчика:_____________________ <?php echo htmlspecialchars($record['client_name']); ?></p>
    </div>
    <button class="btn btn-primary print-button" onclick="window.print()">Распечатать</button>
</body>
</html>
